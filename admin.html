const firebaseConfig = { apiKey: "AIzaSyC71PVDTouBkQ4hRTANelbwRo4AYI6LwnE", projectId: "itwsreq" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const role = sessionStorage.getItem("role");

function loadData(type) {
    db.collection("Requests").where("type","==",type).onSnapshot(snap => {
        let h = "";
        snap.forEach(doc => {
            const d = doc.data();
            h += `<tr>
                <td>${d.refId}</td><td>${d.name}</td><td>${d.timestamp}</td>
                <td>
                    <button onclick="openCard('${doc.id}')" style="background:#10b981; border:none; padding:5px; color:#fff; border-radius:5px;">عرض</button>
                    ${role=='super' ? `<button onclick="deleteDoc('${doc.id}')" style="background:#ef4444; border:none; padding:5px; color:#fff; border-radius:5px;">حذف</button>` : ''}
                </td></tr>`;
        });
        document.getElementById('tbody').innerHTML = h;
    });
}

async function openCard(id) {
    const doc = await db.collection("Requests").doc(id).get();
    const d = doc.data();
    Swal.fire({
        title: 'تفاصيل الطلب',
        background: '#0a1120', color: '#fff',
        html: `<div style="text-align:right; font-size:14px;">
                <p><b>الاسم:</b> ${d.name}</p><p><b>القومي:</b> ${d.nationalId}</p>
                <p><b>الموضوع:</b> ${d.details}</p>
                <select id="sw-status" class="swal2-input" style="color:#000"><option value="تم">إغلاق (تم)</option></select>
               </div>`,
        confirmButtonText: 'تحديث'
    }).then(r => {
        if(r.isConfirmed) updateStage(id, document.getElementById('sw-status').value);
    });
}

async function deleteDoc(id) {
    const { value: p } = await Swal.fire({ title: 'كلمة السر', input: 'password' });
    if(p === '11111@') { await db.collection("Requests").doc(id).delete(); Swal.fire("تم الحذف"); }
}

async function updateStage(id, status) {
    await db.collection("Requests").doc(id).update({ status: status });
    Swal.fire("تم التحديث");
}
loadData('complaint');
