<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة التحكم | الإدارة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #050b18; color: white; font-family: 'Cairo'; margin: 0; display: flex; }
        .sidebar { width: 260px; background: #1e293b; height: 100vh; padding: 20px; position: fixed; }
        .main { margin-right: 280px; padding: 30px; width: 100%; }
        .nav-link { padding: 15px; display: block; color: #94a3b8; text-decoration: none; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
        .nav-link.active { background: #0ea5e9; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #111827; }
        th, td { padding: 15px; border: 1px solid #374151; text-align: center; }
        th { background: #1f2937; color: #0ea5e9; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Cairo'; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="color: #0ea5e9;">لوحة الإدارة</h2>
        <div class="nav-link active" onclick="loadData('complaint', this)">إدارة الشكاوى</div>
        <div class="nav-link" onclick="loadData('suggestion', this)">إدارة المقترحات</div>
        <div class="nav-link" onclick="showSet()">إعدادات النظام</div>
        <div class="nav-link" style="color:red; margin-top:50px;" onclick="location.href='index.html'">خروج</div>
    </div>
    <div class="main">
        <div id="table-box">
            <h2 id="title-text">تقرير الشكاوى</h2>
            <table>
                <thead>
                    <tr>
                        <th>رقم الطلب</th>
                        <th>الاسم</th>
                        <th>المحافظة</th>
                        <th>الحالة</th>
                        <th>إدارة</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div id="set-box" style="display:none;">
            <h2>إعدادات الهوية</h2>
            <input type="text" id="s-name" placeholder="اسم النقابة" style="width:100%; padding:10px; margin:10px 0;">
            <input type="text" id="s-pres" placeholder="اسم النقيب" style="width:100%; padding:10px; margin:10px 0;">
            <input type="text" id="s-logo" placeholder="رابط اللوجو" style="width:100%; padding:10px; margin:10px 0;">
            <button class="btn" style="background:green; color:white" onclick="saveSet()">حفظ الإعدادات</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script>
        firebase.initializeApp({apiKey: "AIzaSyC71PVDTouBkQ4hRTANelbwRo4AYI6LwnE", projectId: "itwsreq"});
        const db = firebase.firestore();
        const role = sessionStorage.getItem("role");

        function loadData(type, el) {
            document.getElementById('table-box').style.display = 'block';
            document.getElementById('set-box').style.display = 'none';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('title-text').innerText = type == 'complaint' ? "تقرير الشكاوى" : "تقرير المقترحات";

            db.collection("Requests").where("type", "==", type).onSnapshot(snap => {
                let h = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    h += `<tr>
                        <td>${d.refId}</td>
                        <td>${d.fullName}</td>
                        <td>${d.governorate}</td>
                        <td>${d.status}</td>
                        <td>
                            <button class="btn" style="background:#0ea5e9; color:white;" onclick="manageDoc('${doc.id}')">إدارة</button>
                            ${role=='super' ? `<button class="btn" style="background:red; color:white; margin-right:5px;" onclick="delDoc('${doc.id}')">حذف</button>` : ''}
                        </td>
                    </tr>`;
                });
                document.getElementById('tbody').innerHTML = h;
            });
        }

        async function manageDoc(id) {
            const doc = await db.collection("Requests").doc(id).get();
            const d = doc.data();
            const { value: form } = await Swal.fire({
                title: 'تحديث حالة الطلب',
                html: `<input id="s1" class="swal2-input" placeholder="اسم المرحلة"><textarea id="s2" class="swal2-textarea" placeholder="كومنت"></textarea>`,
                showCancelButton: true, confirmButtonText: 'تحديث', cancelButtonText: 'تم (إغلاق)'
            });
            if(form) {
                const s = document.getElementById('s1').value;
                const c = document.getElementById('s2').value;
                await db.collection("Requests").doc(id).update({
                    status: s,
                    tracking: firebase.firestore.FieldValue.arrayUnion({stage: s, comment: c, date: new Date().toLocaleString('ar-EG')})
                });
            } else if (Swal.dismissReason === 'cancel') {
                await db.collection("Requests").doc(id).update({status: "تم"});
            }
        }

        function delDoc(id) { if(confirm("حذف؟")) db.collection("Requests").doc(id).delete(); }
        function showSet() { document.getElementById('table-box').style.display='none'; document.getElementById('set-box').style.display='block'; }
        async function saveSet() {
            await db.collection("SystemSettings").doc("mainConfig").set({
                unionName: document.getElementById('s-name').value,
                presidentName: document.getElementById('s-pres').value,
                logoURL: document.getElementById('s-logo').value
            });
            alert("تم الحفظ");
        }
        loadData('complaint');
    </script>
</body>
</html>
