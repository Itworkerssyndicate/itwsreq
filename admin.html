// ... (Firebase Initialize هنا) ...

async function updateRequestStage(docId) {
    const { value: formValues } = await Swal.fire({
        title: 'تحديث حالة الطلب',
        html: `
            <input id="sw-stage" class="swal2-input" placeholder="اسم المرحلة (مثلاً: جاري الفحص)">
            <textarea id="sw-comment" class="swal2-textarea" placeholder="أضف تعليقك هنا..."></textarea>
            <div style="margin-top:10px">
                <input type="checkbox" id="sw-final"> <label for="sw-final">إغلاق الطلب بقرار نهائي</label>
            </div>`,
        showCancelButton: true,
        confirmButtonText: 'تحديث الآن'
    });

    if (formValues) {
        const stage = document.getElementById('sw-stage').value;
        const comment = document.getElementById('sw-comment').value;
        const isFinal = document.getElementById('sw-final').checked;

        await db.collection("Requests").doc(docId).update({
            status: isFinal ? "اغلاق الطلب" : stage,
            tracking: firebase.firestore.FieldValue.arrayUnion({
                stage: isFinal ? "اغلاق الطلب" : stage,
                comment: comment,
                date: new Date().toLocaleString('ar-EG'),
                isFinal: isFinal
            })
        });
        Swal.fire("تم", "تم تحديث المسار بنجاح", "success");
    }
}
