<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إدارة النقابة | التراك سيستم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #050b18; color: white; font-family: 'Cairo'; margin: 0; display: flex; }
        .sidebar { width: 250px; background: #111827; height: 100vh; padding: 20px; position: fixed; border-left: 1px solid #374151; }
        .main { margin-right: 270px; padding: 30px; width: calc(100% - 270px); }
        .nav-item { padding: 15px; margin-bottom: 5px; cursor: pointer; border-radius: 10px; color: #94a3b8; transition: 0.3s; }
        .nav-item.active { background: #0ea5e9; color: white; }
        table { width: 100%; border-collapse: collapse; background: #111827; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #374151; text-align: center; font-size: 0.9rem; }
        .btn-view { background: #0ea5e9; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-del { background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3 style="color: #0ea5e9; text-align: center;">لوحة الإدارة</h3>
        <div id="nav-complaint" class="nav-item active" onclick="loadData('complaint')"><i class="fas fa-file-invoice"></i> إدارة الشكاوى</div>
        <div id="nav-suggestion" class="nav-item" onclick="loadData('suggestion')"><i class="fas fa-lightbulb"></i> المقترحات الواردة</div>
        <div id="nav-settings" class="nav-item" onclick="showSettings()"><i class="fas fa-cog"></i> إعدادات النظام</div>
        <div class="nav-item" style="color:red; margin-top:50px;" onclick="location.href='index.html'">خروج</div>
    </div>

    <div class="main">
        <div id="content-box">
            <h2 id="view-title">تقرير الشكاوى</h2>
            <table>
                <thead>
                    <tr>
                        <th>الرقم المرجعي</th>
                        <th>الاسم</th>
                        <th>المحافظة</th>
                        <th>الحالة</th>
                        <th>الإجراء</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <div id="settings-box" style="display:none;">
            <h2>إعدادات النظام</h2>
            <div style="max-width: 500px;">
                <label>اسم النقابة</label><input type="text" id="set-name" style="width:100%; padding:10px; margin-bottom:10px;">
                <label>اسم النقيب العام</label><input type="text" id="set-pres" style="width:100%; padding:10px; margin-bottom:10px;">
                <label>رابط اللوجو</label><input type="text" id="set-logo" style="width:100%; padding:10px; margin-bottom:10px;">
                <label>رابط موقع الخدمات</label><input type="text" id="set-url" style="width:100%; padding:10px; margin-bottom:10px;">
                <button onclick="saveSettings()" style="background:green; color:white; padding:10px 20px; border:none; cursor:pointer;">حفظ</button>
            </div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script>
    firebase.initializeApp({apiKey: "AIzaSyC71PVDTouBkQ4hRTANelbwRo4AYI6LwnE", projectId: "itwsreq"});
    const db = firebase.firestore();
    const role = sessionStorage.getItem("role");

    function loadData(type) {
        document.getElementById('content-box').style.display='block';
        document.getElementById('settings-box').style.display='none';
        document.getElementById('view-title').innerText = type=='complaint' ? "إدارة الشكاوى" : "إدارة المقترحات";
        
        db.collection("Requests").where("type", "==", type).onSnapshot(snap => {
            let h = "";
            snap.forEach(doc => {
                const d = doc.data();
                h += `<tr>
                    <td>${d.refId}</td>
                    <td>${d.name || d.fullName}</td>
                    <td>${d.gov || d.governorate}</td>
                    <td><span style="color:${d.status=='تم'?'#10b981':'#0ea5e9'}">${d.status}</span></td>
                    <td>
                        <button class="btn-view" onclick="openCard('${doc.id}', '${type}')">إدارة</button>
                        ${role=='super' ? `<button class="btn-del" onclick="deleteDoc('${doc.id}')">حذف</button>` : ''}
                    </td>
                </tr>`;
            });
            document.getElementById('tbody').innerHTML = h;
        });
    }

    async function openCard(id, type) {
        const doc = await db.collection("Requests").doc(id).get();
        const d = doc.data();
        
        if(type == 'suggestion') {
            await db.collection("Requests").doc(id).update({status: "تمت القراءة"});
            return Swal.fire({ title: 'تفاصيل الاقتراح', html: `<p><b>الاسم:</b> ${d.name}</p><p><b>المحتوى:</b> ${d.details}</p>`, background: '#1e293b', color: '#fff' });
        }

        const { value: form } = await Swal.fire({
            title: 'إدارة الشكوى',
            background: '#1e293b', color: '#fff',
            html: `
                <div style="text-align:right; font-size:0.8rem; background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
                    <p><b>الاسم:</b> ${d.name} | <b>المحافظة:</b> ${d.gov}</p>
                    <p><b>التليفون:</b> ${d.phone} | <b>المهنة:</b> ${d.job}</p>
                    <p><b>العنوان:</b> ${d.address}</p>
                    <hr>
                    <p><b>الموضوع:</b> ${d.details}</p>
                </div>
                <input id="sw-stage" class="swal2-input" placeholder="اسم المرحلة القادمة">
                <textarea id="sw-comm" class="swal2-textarea" placeholder="كومنت لإغلاق المرحلة السابقة"></textarea>
            `,
            showCancelButton: true, confirmButtonText: 'تحديث المرحلة', cancelButtonText: 'تم (إغلاق نهائي)'
        });

        if(form) {
            const st = document.getElementById('sw-stage').value;
            const co = document.getElementById('sw-comm').value;
            if(!st) return;
            await db.collection("Requests").doc(id).update({
                status: st,
                tracking: firebase.firestore.FieldValue.arrayUnion({stage: st, comment: co, date: new Date().toLocaleString('ar-EG')})
            });
        } else if (Swal.dismissReason === 'cancel') {
            await db.collection("Requests").doc(id).update({
                status: "تم",
                tracking: firebase.firestore.FieldValue.arrayUnion({stage: "تم", comment: "تمت المعالجة والإغلاق", date: new Date().toLocaleString('ar-EG')})
            });
        }
    }

    async function deleteDoc(id) {
        const { value: pass } = await Swal.fire({ title: 'كلمة سر الحذف', input: 'password', background: '#1e293b', color: '#fff' });
        if(pass === '11111@') {
            await db.collection("Requests").doc(id).delete();
            Swal.fire("تم الحذف", "", "success");
        } else {
            Swal.fire("خطأ", "كلمة سر خاطئة", "error");
        }
    }

    function showSettings() { 
        document.getElementById('content-box').style.display='none'; 
        document.getElementById('settings-box').style.display='block';
        db.collection("SystemSettings").doc("mainConfig").get().then(doc => {
            const d = doc.data();
            document.getElementById('set-name').value = d.unionName;
            document.getElementById('set-pres').value = d.presidentName;
            document.getElementById('set-logo').value = d.logoURL;
            document.getElementById('set-url').value = d.servicesURL;
        });
    }

    async function saveSettings() {
        await db.collection("SystemSettings").doc("mainConfig").update({
            unionName: document.getElementById('set-name').value,
            presidentName: document.getElementById('set-pres').value,
            logoURL: document.getElementById('set-logo').value,
            servicesURL: document.getElementById('set-url').value
        });
        Swal.fire("تم الحفظ", "", "success");
    }

    loadData('complaint');
</script>
</body>
</html>
